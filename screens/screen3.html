<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pantalla 3: Dystopia (1985A) | Git to the Future</title>
  
  <!-- CSS Modular -->
  <link rel="stylesheet" href="../css/variables.css">
  <link rel="stylesheet" href="../css/components/base.css">
  <link rel="stylesheet" href="../css/components/branch-indicator.css">
  <link rel="stylesheet" href="../css/components/console.css">
  <link rel="stylesheet" href="../css/components/graph.css">
  <link rel="stylesheet" href="../css/components/navigation.css">
  
  <!-- GitGraph CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@gitgraph/js"></script>

  <style>
    /* Tema oscuro dist√≥pico */
    body {
      background: linear-gradient(135deg, #1a0000 0%, #0f0f1e 100%);
    }
    .header {
      border-bottom: 2px solid #d32f2f;
    }
  </style>
</head>
<body class="screen-body">
  <!-- Header Principal de la App -->
  <header class="app-header">
    <a href="../index.html" style="text-decoration: none;">
      
      <h1 class="app-header__title">GIT TO THE FUTURE</h1>
    </a>
  </header>

  <!-- Navegaci√≥n Superior -->
  <div id="navigationContainer"></div>

  <!-- Header de la Pantalla -->
  <header class="header">
    <div class="container">
      <div id="breadcrumbContainer"></div>
      <h1 class="text-gradient" style="color: #ff4081;">‚ö†Ô∏è Pantalla 3: Dystopia (1985A)</h1>
      <p class="text-muted">Biff Tannen ha creado una l√≠nea temporal dist√≥pica. Aprende a arreglar historiales corruptos</p>
    </div>
  </header>

  <!-- Contenido Principal -->
  <main class="container" style="max-width: 1400px; margin: 0 auto; padding: var(--spacing-xl);">
    
    <!-- Historia / Contexto -->
    <section class="card card--accent" style="margin-bottom: var(--spacing-lg); border-color: #d32f2f;">
      <h2>üìñ Historia: La L√≠nea Temporal Corrupta</h2>
      <p>
        Al regresar de 2015, Marty y Doc descubren que est√°n en un <strong>1985 alternativo dist√≥pico</strong>. 
        Biff Tannen ha usado el almanaque deportivo para hacerse rico y poderoso, corrompiendo toda la l√≠nea temporal.
      </p>
      <p>
        En esta pantalla aprender√°s comandos avanzados de Git para <strong>arreglar historiales corruptos</strong>:
      </p>
      <ul>
        <li><code>git reset --hard</code> - Deshacer cambios y volver a un estado anterior</li>
        <li><code>git merge</code> - Fusionar l√≠neas temporales correctas</li>
        <li><code>git revert</code> - Revertir commits espec√≠ficos sin perder historial</li>
        <li>Entender c√≥mo recuperarse de errores en Git</li>
      </ul>
      <div class="badge badge--error" style="margin-top: var(--spacing-md); background: linear-gradient(135deg, #d32f2f, #f44336);">
        ‚ö†Ô∏è PELIGRO: git reset --hard elimina cambios permanentemente. √ösalo con precauci√≥n
      </div>
    </section>

    <!-- Progreso de Ejercicios -->
    <div id="exerciseProgress"></div>

    <!-- Instrucciones del Ejercicio Actual -->
    <div id="exerciseInstructions"></div>

    <!-- Grid de Dos Columnas -->
    <div class="grid" style="grid-template-columns: 1fr 1fr; gap: var(--spacing-lg); margin-top: var(--spacing-lg);">
      
      <!-- Columna Izquierda: Gr√°fico -->
      <div class="graph" style="border-color: #d32f2f;">
        <div class="branch-indicator" style="background: linear-gradient(135deg, #d32f2f, #f44336);">
          <span class="branch-indicator__label">‚ö†Ô∏è L√≠nea Corrupta:</span>
          <span class="branch-indicator__value" id="currentBranchIndicator">1985-dystopia</span>
        </div>
        
        <h2 class="graph__title" style="color: #ff4081;">üíÄ Historial Corrupto</h2>
        <p class="graph__description">Visualiza el historial dist√≥pico y c√≥mo arreglarlo</p>
        
        <div class="graph__canvas" id="gitGraph"></div>

        <!-- Advertencia -->
        <div class="graph__info" style="border-color: #d32f2f; background: rgba(211, 47, 47, 0.1);">
          <div class="graph__info-item">
            <span class="graph__info-label">‚ö†Ô∏è Estado:</span>
            <span class="graph__info-value" style="color: #f44336;">L√çNEA TEMPORAL CORRUPTA</span>
          </div>
          <div class="graph__info-item">
            <span class="graph__info-label">üéØ Objetivo:</span>
            <span class="graph__info-value">Restaurar 1985 original</span>
          </div>
        </div>
      </div>

      <!-- Columna Derecha: Consola -->
      <div class="console" style="border-color: #d32f2f;">
        <h2 class="console__title" style="color: #ff4081;">üñ•Ô∏è Terminal de Reparaci√≥n Temporal</h2>
        <p class="console__description">Usa comandos avanzados para restaurar la l√≠nea temporal</p>

        <!-- Output de la Consola -->
        <div class="console__output" id="consoleOutput">
          <div class="console__output-line console__output-line--warning">
            <span class="prompt">$</span> Doc: "¬°Marty! Este no es nuestro 1985... algo sali√≥ terriblemente mal" üò±
          </div>
          <div class="console__output-line console__output-line--warning">
            <span class="prompt">$</span> Biff ha corrompido la l√≠nea temporal. Debemos usar git para arreglarlo
          </div>
        </div>

        <!-- Botones de Comandos R√°pidos -->
        <div class="console__commands">
          <button class="console__cmd-btn" data-command="log">log</button>
          <button class="console__cmd-btn" data-command="branch">branch</button>
          <button class="console__cmd-btn" data-command="checkout main">checkout main</button>
          <button class="console__cmd-btn" data-command="merge 1985-dystopia">merge</button>
          <button class="console__cmd-btn" data-command="reset --hard HEAD~1">reset --hard</button>
          <button class="console__cmd-btn" data-command="revert HEAD">revert</button>
        </div>

        <!-- Input de Comando -->
        <div class="console__input">
          <span class="console__input-prompt" style="color: #f44336;">git $</span>
          <input 
            type="text" 
            class="console__input-field" 
            id="commandInput" 
            placeholder="Comandos de recuperaci√≥n..."
            autocomplete="off"
          >
          <button class="console__execute-btn" id="executeBtn" style="background: #d32f2f;">‚ñ∂</button>
        </div>

        <!-- Botones Especiales -->
        <div class="console__special-buttons">
          <button class="console__special-btn console__special-btn--reset" id="resetBtn">
            üîÑ Reiniciar
          </button>
          <button class="console__special-btn console__special-btn--demo" id="hintBtn">
            üí° Pista
          </button>
        </div>
      </div>

    </div>

    <!-- Comparaci√≥n Visual -->
    <section class="card card--primary" style="margin-top: var(--spacing-lg);">
      <h3>‚öñÔ∏è Comparaci√≥n de L√≠neas Temporales</h3>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-lg); padding: var(--spacing-md) 0;">
        <div style="text-align: center; padding: var(--spacing-md); border: 2px solid #4caf50; border-radius: 8px;">
          <div style="font-size: 48px;">‚úÖ</div>
          <strong style="color: #4caf50;">1985 Original</strong>
          <ul style="text-align: left; margin-top: var(--spacing-sm); color: var(--color-muted); font-size: 14px;">
            <li>George es exitoso</li>
            <li>Familia feliz</li>
            <li>Biff es amable</li>
            <li>Hill Valley pr√≥spero</li>
          </ul>
        </div>
        <div style="text-align: center; padding: var(--spacing-md); border: 2px solid #f44336; border-radius: 8px;">
          <div style="font-size: 48px;">‚ùå</div>
          <strong style="color: #f44336;">1985 Dist√≥pico</strong>
          <ul style="text-align: left; margin-top: var(--spacing-sm); color: var(--color-muted); font-size: 14px;">
            <li>George est√° muerto</li>
            <li>Biff es millonario</li>
            <li>Lorraine casada con Biff</li>
            <li>Hill Valley corrupto</li>
          </ul>
        </div>
      </div>
    </section>

    <!-- Ayuda Adicional -->
    <section class="card card--secondary" style="margin-top: var(--spacing-lg);">
      <h3>üéì Comandos de Recuperaci√≥n</h3>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: var(--spacing-md);">
        <div>
          <strong style="color: #f44336;">git reset --hard [commit]</strong>
          <p class="text-muted text-sm">Vuelve el repositorio a un commit espec√≠fico, descartando todos los cambios</p>
          <code class="text-xs">‚ö†Ô∏è PELIGRO: P√©rdida permanente de cambios</code>
        </div>
        <div>
          <strong style="color: #ff9100;">git revert [commit]</strong>
          <p class="text-muted text-sm">Crea un nuevo commit que deshace los cambios de un commit anterior</p>
          <code class="text-xs">‚úÖ SEGURO: Preserva el historial</code>
        </div>
        <div>
          <strong style="color: #4caf50;">git merge [rama]</strong>
          <p class="text-muted text-sm">Fusiona cambios de otra rama a la actual</p>
          <code class="text-xs">Combina l√≠neas temporales</code>
        </div>
      </div>
    </section>

  </main>

  <!-- Footer -->
  <footer class="text-center text-muted" style="padding: var(--spacing-xl); margin-top: var(--spacing-xl);">
    <p>üöó‚ö° Git to the Future - Aprende Git usando Back to the Future</p>
    <p class="text-sm">Pantalla 3 de 4 | Dystopia (1985A)</p>
  </footer>

  <!-- JavaScript Modular -->
  <script type="module">
    import { 
      GitGraphController, 
      ConsoleController, 
      ScreenController,
      ExerciseValidator,
      SCREEN_EXERCISES,
      UIController,
      Logger 
    } from '../js/modules/index.js';

    Logger.log('Iniciando Pantalla 3: Dystopia');

    const graph = new GitGraphController('gitGraph');
    const consoleCtrl = new ConsoleController('consoleOutput', 'commandInput', graph);
    const validator = new ExerciseValidator(consoleCtrl, graph);
    const ui = new UIController();
    const screenCtrl = new ScreenController();

    // Inicializar con escenario dist√≥pico
    graph.initialize();
    graph.commit('1985 - Presente Normal');
    graph.createBranch('1985-dystopia');
    graph.checkout('1985-dystopia');
    graph.commit('‚ö†Ô∏è Biff obtiene el almanaque');
    graph.commit('üí∞ Biff se hace millonario');
    graph.commit('üíÄ George McFly muere');
    
    consoleCtrl.state.initialized = true;
    consoleCtrl.state.branches.push('1985-dystopia');
    consoleCtrl.state.currentBranch = '1985-dystopia';
    ui.updateBranchIndicator('1985-dystopia');

    // Configurar ejercicios
    validator.setExercises(SCREEN_EXERCISES.screen3);

    // Renderizar UI
    screenCtrl.renderNavigation('navigationContainer');
    screenCtrl.renderBreadcrumb('breadcrumbContainer');

    const firstExercise = validator.getCurrentExercise();
    if (firstExercise) {
      ui.showExerciseInstructions(firstExercise, 'exerciseInstructions');
      ui.updateExerciseProgress(0, SCREEN_EXERCISES.screen3.length, 'exerciseProgress');
    }

    // Interceptar comandos
    const originalExecute = consoleCtrl.executeCommand.bind(consoleCtrl);
    consoleCtrl.executeCommand = function(commandString) {
      originalExecute(commandString);

      const parts = commandString.trim().toLowerCase().split(' ');
      const command = parts[0] === 'git' ? parts[1] : parts[0];
      const args = parts[0] === 'git' ? parts.slice(2) : parts.slice(1);

      const result = validator.validateCommand(command, args);
      
      if (result.valid) {
        ui.showNotification(result.message, 'success');
        const nextResult = validator.nextExercise();
        
        if (nextResult.completed) {
          ui.showNotification('üéâ ¬°Has restaurado la l√≠nea temporal correcta!', 'success', 5000);
          ui.createConfetti();
          screenCtrl.completeScreen(3);
          
          setTimeout(() => {
            ui.showCompletionModal('Dystopia (1985A)', () => {
              screenCtrl.navigateTo(4);
            });
          }, 2000);
        } else {
          ui.updateExerciseProgress(
            validator.currentExerciseIndex,
            SCREEN_EXERCISES.screen3.length,
            'exerciseProgress'
          );
          ui.showExerciseInstructions(nextResult.exercise, 'exerciseInstructions');
        }
      }
    };

    // Event listeners
    document.getElementById('executeBtn').addEventListener('click', () => {
      const input = document.getElementById('commandInput');
      const command = input.value.trim();
      if (command) {
        consoleCtrl.executeCommand(command);
        input.value = '';
      }
    });

    document.getElementById('commandInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        document.getElementById('executeBtn').click();
      }
    });

    document.querySelectorAll('.console__cmd-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.getElementById('commandInput').value = btn.getAttribute('data-command');
        document.getElementById('commandInput').focus();
      });
    });

    document.getElementById('resetBtn').addEventListener('click', () => {
      if (confirm('¬øReiniciar la pantalla?')) {
        location.reload();
      }
    });

    document.getElementById('hintBtn').addEventListener('click', () => {
      const exercise = validator.getCurrentExercise();
      if (exercise && exercise.hint) {
        ui.showNotification(exercise.hint, 'info', 5000);
      }
    });

    // Actualizar indicador
    const originalCheckout = graph.checkout.bind(graph);
    graph.checkout = function(branchName) {
      const result = originalCheckout(branchName);
      if (result) {
        ui.updateBranchIndicator(branchName);
      }
      return result;
    };

    Logger.log('Pantalla 3 lista - Modo Dist√≥pico activado');
  </script>

</body>
</html>
