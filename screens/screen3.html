<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pantalla 3: La Distop√≠a de Biff | Git to the Future</title>

    <!-- CSS Modular -->
    <link rel="stylesheet" href="../css/variables.css" />
    <link rel="stylesheet" href="../css/components/base.css" />
    <link rel="stylesheet" href="../css/components/branch-indicator.css" />
    <link rel="stylesheet" href="../css/components/console.css" />
    <link rel="stylesheet" href="../css/components/graph.css" />
    <link rel="stylesheet" href="../css/components/navigation.css" />
    <link rel="stylesheet" href="../css/screens.css" />

    <!-- GitGraph CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@gitgraph/js"></script>
  </head>
  <body class="screen-body screen-3">
    <!-- Header con Logo y Back Button -->
    <header class="screen-header">
      <div class="screen-header__left">
        <a href="../index-menu.html" title="Volver al men√∫ principal" id="backBtn">
          <img
            src="../assets/fonts/img/Back.png"
            alt="Volver"
            class="screen-header__back"
          />
        </a>
      </div>
      <a href="../index.html">
        <img
          src="../assets/fonts/img/GItToTheFuture.png"
          alt="Git to the Future"
          class="screen-header__logo"
        />
      </a>

      <!-- Barra de Progreso Radioactiva (Superior Derecha) -->
      <div class="plutonium-progress">
        <span class="plutonium-progress__label">PROGRESO</span>
        <div class="plutonium-progress__tube">
          <div
            class="plutonium-progress__fill"
            id="progressBarFill"
            style="width: 0%"
          >
            <div class="plutonium-progress__glow"></div>
          </div>
          <span class="plutonium-progress__counter" id="progressCounter"
            >0/9</span
          >
        </div>
      </div>
    </header>

    <!-- Layout Principal de 3 Columnas -->
    <main class="screen-main">
      <!-- COLUMNA IZQUIERDA: Consola Git Interactiva (PROTAGONISTA - 55-60%) -->
      <div class="screen-left">
        <!-- Consola -->
        <div class="console-card">
          <div class="console-card__header">
            <h2 class="console-card__title">Git Terminal</h2>
          </div>

          <!-- Output de la Consola -->
          <div class="console__output" id="consoleOutput"></div>

          <!-- Botones de Comandos R√°pidos -->
          <div class="console__commands">
            <button class="console__cmd-btn" data-command="pull">pull</button>
            <button class="console__cmd-btn" data-command="checkout 1955">
              checkout
            </button>
            <button class="console__cmd-btn" data-command="branch fix/burn-almanac">branch</button>
            <button class="console__cmd-btn" data-command="revert HEAD">
              revert
            </button>
            <button class="console__cmd-btn" data-command="merge fix/burn-almanac">
              merge
            </button>
            <button class="console__cmd-btn" data-command="cherry-pick">
              cherry-pick
            </button>
            <button class="console__cmd-btn" data-command="apply carta_doc_1885.patch">
              apply
            </button>
          </div>

          <!-- Input de Comando -->
          <div class="console__input">
            <span class="console__input-prompt">git $</span>
            <input
              type="text"
              class="console__input-field"
              id="commandInput"
              placeholder="Escribe tu comando aqu√≠..."
              autocomplete="off"
            />
            <button class="console__execute-btn" id="executeBtn">‚ñ∂</button>
          </div>

          <!-- Botones Especiales -->
          <div class="console__special-buttons">
            <button
              class="console__special-btn console__special-btn--reset"
              id="resetBtn"
            >
              Reiniciar
            </button>
            <button
              class="console__special-btn console__special-btn--demo"
              id="hintBtn"
            >
              Pista
            </button>
          </div>
        </div>
      </div>

      <!-- COLUMNA CENTRAL: Visualizador de √Årbol Git (SECUNDARIA - 20-25%) -->
      <div class="screen-center">
        <!-- Gr√°fico Git -->
        <div class="graph-card">
          <div class="graph-card__header">
            <h2 class="graph-card__title">Git Timeline</h2>
          </div>

          <div class="graph__canvas" id="gitGraph">
            <div class="graph__empty">
              <div class="graph__empty-line"></div>
              <div class="graph__empty-line"></div>
              <div class="graph__empty-text">
                Visualizador de L√≠neas Temporales
              </div>
              <div class="graph__empty-line"></div>
              <div class="graph__empty-hint">
                Aqu√≠ ver√°s todas las ramas, commits y fusiones de tu repositorio
              </div>
              <div class="graph__empty-hint">
                Git en forma de √°rbol visual. Ejecuta "git init" para comenzar.
              </div>
              <div class="graph__empty-line"></div>
            </div>
          </div>

          <!-- Branch Indicator movido abajo -->
          <div class="branch-indicator">
            <span class="branch-indicator__label">Branch:</span>
            <span class="branch-indicator__value" id="currentBranchIndicator"
              >Sin repositorio</span
            >
          </div>
        </div>
      </div>

      <!-- COLUMNA DERECHA: Cards de Informaci√≥n (CONTEXTO - 15-20%) -->
      <div class="screen-right">
        <!-- Tarjeta de Misi√≥n -->
        <div class="mission-card mission-card--objective">
          <h2 class="mission-card__title">Mission Objective</h2>
          <p class="mission-card__text" id="exerciseInstructions">
            Inicializa la m√°quina del tiempo
          </p>
        </div>

        <!-- Historia del Nivel -->
        <div class="mission-card">
          <h2 class="mission-card__title">Level Context</h2>
          <p
            class="mission-card__description"
            style="margin-bottom: 12px; font-size: 13px; line-height: 1.6"
          >
            <strong style="color: #ff6659">üòà La Distop√≠a de Biff</strong><br />
            <strong>üìÖ A√±o:</strong> 1985A (Corrompido)<br />
            <strong>‚ö†Ô∏è Crisis:</strong> Historia Reescrita
          </p>
          <p
            class="mission-card__description"
            style="font-size: 13px; line-height: 1.6"
          >
            Marty y Doc est√°n en 2015, pero al hacer pull descubren que Biff 
            ha reescrito la historia (git reset --hard). Hill Valley es una distop√≠a: 
            Biff millonario, George muerto. Debes usar git revert para deshacer 
            el cambio quemando el almanaque, cherry-pick para rescatar a Jennifer, 
            y git apply para recibir la carta de Doc desde 1885.
          </p>
          <div
            style="
              margin-top: 12px;
              padding-top: 12px;
              border-top: 1px solid rgba(255, 255, 255, 0.1);
            "
          >
            <img
              src="../assets/fonts/img/thunder.png"
              alt="1985A"
              style="
                width: 100%;
                max-width: 180px;
                height: auto;
                margin: 0 auto;
                display: block;
                border-radius: 6px;
                filter: drop-shadow(0 4px 12px rgba(0, 0, 0, 0.3));
              "
            />
          </div>
        </div>

        <!-- Tarjeta de Pista -->
        <div class="mission-card mission-card--hint" id="hintCard" style="display: none;">
          <h2 class="mission-card__title">PISTA</h2>
          <p class="mission-card__text" id="hintText" style="font-size: 13px; line-height: 1.6; color: rgba(255, 255, 255, 0.9);">
            <!-- La pista se mostrar√° aqu√≠ -->
          </p>
        </div>
      </div>
    </main>

    <!-- JavaScript sin m√≥dulos ES6 -->
    <script src="../js/git-bttf-standalone.js"></script>
    <script>
      // Inicializar cuando se cargue la p√°gina
      document.addEventListener('DOMContentLoaded', function () {
        Logger.log('Iniciando Pantalla 3: Dystopia');

        // 1Ô∏è‚É£ Inicializar controladores
        const graph = new GitGraphController('gitGraph');
        const consoleCtrl = new ConsoleController(
          'consoleOutput',
          'commandInput',
          graph
        );
        const validator = new ExerciseValidator(consoleCtrl, graph);
        const ui = new UIController();
        const screenCtrl = new ScreenController();

        // 2Ô∏è‚É£ Configurar ejercicios y conectar validador
        validator.setExercises(SCREEN_EXERCISES.screen3);
        consoleCtrl.setValidator(validator);

        // üé¨ Hardcoded: Repositorio con timeline corrupto
        consoleCtrl.state.initialized = true;
        consoleCtrl.state.branches = ['main', 'biff-paradise'];
        consoleCtrl.state.currentBranch = 'main';
        consoleCtrl.state.remotes = [{
          name: 'origin',
          url: 'https://github.com/hill-valley/timeline-corrupted.git',
          branches: ['main', 'biff-paradise']
        }];
        
        // Inicializar grafo
        graph.init();
        
        // Commits en main (timeline normal)
        graph.commit('1985: Vida normal');
        consoleCtrl.state.commits.push({
          hash: 'aaa1985',
          message: '1985: Vida normal',
          branch: 'main',
          timestamp: Date.now()
        });
        
        graph.commit('1955: Viaje al pasado');
        consoleCtrl.state.commits.push({
          hash: 'bbb1955',
          message: '1955: Viaje al pasado',
          branch: 'main',
          timestamp: Date.now()
        });
        
        // Crear branch corrupto biff-paradise
        graph.branch('biff-paradise');
        graph.checkout('biff-paradise');
        consoleCtrl.state.currentBranch = 'biff-paradise';
        
        graph.commit('Biff recibe almanaque deportivo');
        consoleCtrl.state.commits.push({
          hash: 'ccc1955',
          message: 'Biff recibe almanaque deportivo',
          branch: 'biff-paradise',
          timestamp: Date.now()
        });
        
        graph.commit('1985A: Distop√≠a de Biff');
        consoleCtrl.state.commits.push({
          hash: 'ddd1985a',
          message: '1985A: Distop√≠a de Biff',
          branch: 'biff-paradise',
          timestamp: Date.now()
        });
        
        // Volver a main
        graph.checkout('main');
        consoleCtrl.state.currentBranch = 'main';
        
        consoleCtrl.addOutput('‚ö†Ô∏è ADVERTENCIA: Timeline corrupto detectado');
        consoleCtrl.addOutput('üìç Branch "biff-paradise" contiene una realidad alternativa');
        consoleCtrl.addOutput('üí° Deber√°s usar comandos avanzados para restaurar el timeline');

        // 3Ô∏è‚É£ Funci√≥n para actualizar la UI del progreso
        function updateProgress() {
          const current = validator.currentExerciseIndex;
          const total = SCREEN_EXERCISES.screen3.length;
          // Calcular porcentaje: cuando current === total, debe ser 100%
          const percentage = Math.round((current / total) * 100);

          const progressFill = document.getElementById('progressBarFill');
          const progressCounter = document.getElementById('progressCounter');

          if (progressFill) {
            progressFill.style.width = percentage + '%';
          }

          if (progressCounter) {
            // Mostrar ejercicios completados
            progressCounter.textContent = `${current}/${total}`;
          }

          // Debug para verificar
          console.log(
            `Progreso actualizado: ${current}/${total} (${percentage}%)`
          );
        }

        // 4Ô∏è‚É£ Funci√≥n para actualizar instrucciones
        function updateInstructions(exercise) {
          const container = document.getElementById('exerciseInstructions');
          if (container && exercise) {
            container.textContent = exercise.description;
          }
        }

        // 5Ô∏è‚É£ Mostrar primer ejercicio
        updateInstructions(validator.getCurrentExercise());
        updateProgress();

        // 6Ô∏è‚É£ Interceptar comandos para validaci√≥n autom√°tica
        const originalExecute = consoleCtrl.executeCommand.bind(consoleCtrl);
        consoleCtrl.executeCommand = function (commandString) {
          const cmd = commandString.trim().toLowerCase();

          // Comandos de ayuda no necesitan validaci√≥n
          if (
            cmd === 'hint' ||
            cmd === 'ayuda' ||
            cmd === 'help' ||
            cmd === 'clear'
          ) {
            originalExecute(commandString);
            return;
          }

          // Ejecutar comando
          originalExecute(commandString);

          // Validar ejercicio actual
          const parts = cmd.split(' ');
          const command = parts[0] === 'git' ? parts[1] : parts[0];
          const args = parts[0] === 'git' ? parts.slice(2) : parts.slice(1);

          const result = validator.validateCommand(command, args);

          if (result.valid) {
            // ‚úÖ Comando correcto - Sin notificaci√≥n popup
            const nextResult = validator.nextExercise();

            if (nextResult.completed) {
              // Actualizar progreso al 100% antes de mostrar completaci√≥n
              updateProgress();
              
              // üéâ ¬°Pantalla completada!
              ui.showNotification(
                'üéâ ¬°Has completado la Pantalla 3!',
                'success',
                5000
              );
              ui.createConfetti();
              screenCtrl.completeScreen(3);

              setTimeout(() => {
                ui.showCompletionModal('Dystopia (1985A)', () => {
                  screenCtrl.navigateTo(4);
                });
              }, 2000);
            } else {
              // üìù Mostrar siguiente ejercicio
              updateProgress();
              updateInstructions(nextResult.exercise);
            }
          } else {
            // ‚ùå Comando incorrecto - Mostrar error y NO avanzar
            const errorMsg = result.suggestion || '‚ùå Comando incorrecto. Usa "hint" para obtener ayuda.';
            ui.showNotification(errorMsg, 'error', 4000);
          }
        };

        // 7Ô∏è‚É£ Event Listeners
        // Ejecutar comando con bot√≥n o Enter
        const executeCommand = () => {
          const input = document.getElementById('commandInput');
          const command = input.value.trim();
          if (command) {
            consoleCtrl.executeCommand(command);
            input.value = '';
          }
        };

        document
          .getElementById('executeBtn')
          .addEventListener('click', executeCommand);
        document
          .getElementById('commandInput')
          .addEventListener('keypress', (e) => {
            if (e.key === 'Enter') executeCommand();
          });

        // Botones de comando r√°pido
        document.querySelectorAll('.console__cmd-btn').forEach((btn) => {
          btn.addEventListener('click', () => {
            const command = btn.getAttribute('data-command');
            document.getElementById('commandInput').value = command;
            document.getElementById('commandInput').focus();
          });
        });

        // Bot√≥n de reiniciar
        document.getElementById('resetBtn').addEventListener('click', () => {
          if (
            confirm(
              '¬øEst√°s seguro de reiniciar? Perder√°s todo el progreso de esta pantalla.'
            )
          ) {
            consoleCtrl.resetAll();
            validator.reset();
            updateInstructions(SCREEN_EXERCISES.screen3[0]);
            updateProgress();
            ui.showNotification('üîÑ Pantalla reiniciada', 'info');
          }
        });

        // Bot√≥n de pista progresiva (si existe)
        const hintBtn = document.getElementById('hintBtn');
        if (hintBtn) {
          hintBtn.addEventListener('click', () => {
            const exercise = validator.getCurrentExercise();
            const hintCard = document.getElementById('hintCard');
            const hintText = document.getElementById('hintText');
            
            if (exercise && hintCard && hintText) {
              hintText.textContent = exercise.hint;
              
              // Remover clase hide si existe
              hintCard.classList.remove('hide');
              
              // Mostrar con animaci√≥n
              hintCard.style.display = 'block';
              
              // Forzar reflow para que la animaci√≥n funcione
              void hintCard.offsetWidth;
              
              // Agregar clase show para activar animaci√≥n
              hintCard.classList.add('show');
              
              // Auto-ocultar despu√©s de 8 segundos con animaci√≥n
              setTimeout(() => {
                hintCard.classList.remove('show');
                hintCard.classList.add('hide');
                
                // Esperar a que termine la animaci√≥n antes de ocultar
                setTimeout(() => {
                  hintCard.style.display = 'none';
                  hintCard.classList.remove('hide');
                }, 400);
              }, 8000);
            }
          });
        }

        // Actualizar indicador de rama
        const originalCheckout = graph.checkout.bind(graph);
        graph.checkout = function (branchName) {
          const result = originalCheckout(branchName);
          if (result) ui.updateBranchIndicator(branchName);
          return result;
        };

        // Confirmar antes de salir si hay progreso
        const backBtn = document.getElementById('backBtn');
        if (backBtn) {
          backBtn.addEventListener('click', (e) => {
            const currentExercise = validator.getCurrentExercise();
            // Si ya complet√≥ al menos un ejercicio, mostrar advertencia
            if (currentExercise && currentExercise.id > 1) {
              e.preventDefault();
              const confirmed = confirm(
                '‚ö†Ô∏è Si regresas al men√∫, perder√°s todo tu progreso en este nivel.\n\n¬øEst√°s seguro de que quieres salir?'
              );
              if (confirmed) {
                window.location.href = backBtn.getAttribute('href');
              }
            }
            // Si est√° en el primer ejercicio, dejar salir sin confirmar
          });
        }

        Logger.log('Pantalla 3 inicializada correctamente');
      });
    </script>
  </body>
</html>
