<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pantalla 3: Dystopia (1985A) | Git to the Future</title>

    <!-- CSS Modular -->
    <link rel="stylesheet" href="../css/variables.css" />
    <link rel="stylesheet" href="../css/components/base.css" />
    <link rel="stylesheet" href="../css/components/branch-indicator.css" />
    <link rel="stylesheet" href="../css/components/console.css" />
    <link rel="stylesheet" href="../css/components/graph.css" />
    <link rel="stylesheet" href="../css/components/navigation.css" />
    <link rel="stylesheet" href="../css/screens.css" />

    <!-- GitGraph CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@gitgraph/js"></script>
  </head>
  <body class="screen-body screen-dystopia">
    <!-- Bot√≥n de Volver -->
    <a href="../index-menu.html" title="Volver al men√∫ principal">
      <img
        src="../assets/fonts/img/Back.png"
        alt="Volver"
        style="
          position: fixed;
          top: 20px;
          left: 20px;
          height: 40px;
          cursor: pointer;
          z-index: 1000;
        "
      />
    </a>
    <!-- Header Principal de la App -->
    <header class="app-header">
      <a href="../index.html" style="text-decoration: none">
        <h1 class="app-header__title">GIT TO THE FUTURE</h1>
      </a>
    </header>

    <!-- Navegaci√≥n Superior -->
    <div id="navigationContainer"></div>

    <!-- Header de la Pantalla -->
    <header class="header">
      <div class="container">
        <div id="breadcrumbContainer"></div>
        <h1 class="text-gradient" style="color: #ff4081">
          ‚ö†Ô∏è Pantalla 3: Dystopia (1985A)
        </h1>
        <p class="text-muted">
          Crea la rama "familia-feliz" y resuelve la paradoja de Biff con merges
          avanzados y cherry-picks
        </p>
      </div>
    </header>

    <!-- Contenido Principal -->
    <main
      class="container"
      style="max-width: 1400px; margin: 0 auto; padding: var(--spacing-xl)"
    >
      <!-- Historia / Contexto -->
      <section
        class="card card--accent"
        style="margin-bottom: var(--spacing-lg); border-color: #d32f2f"
      >
        <h2>üìñ Historia: Familia Feliz y Comandos Avanzados</h2>
        <p>
          Despu√©s de recuperar el almanaque, Marty crea la rama
          <strong>"familia-feliz"</strong> que representa el
          <strong>1985 mejorado</strong>. Pero ahora necesitar√°s comandos m√°s
          avanzados para manipular la historia de forma precisa.
        </p>
        <p>
          En esta pantalla dominar√°s <strong>Git intermedio-avanzado</strong>:
        </p>
        <ul>
          <li>
            <code>git rebase</code> - üî• Reorganizar y limpiar la historia
          </li>
          <li>
            <code>git cherry-pick</code> - üçí Copiar commits espec√≠ficos entre
            ramas
          </li>
          <li>
            <code>git branch</code> - Crear "familia-feliz" (mejor realidad)
          </li>
          <li><code>git commit</code> - Registrar eventos clave</li>
          <li><code>git merge</code> - Fusionar y consolidar cambios</li>
        </ul>
        <p class="text-muted" style="margin-top: var(--spacing-md)">
          <strong>üéØ Objetivo:</strong> Completar 8 ejercicios usando comandos
          avanzados para crear la mejor realidad.
        </p>
        <div
          class="badge badge--warning"
          style="
            margin-top: var(--spacing-md);
            background: linear-gradient(135deg, #f57c00, #ff9800);
          "
        >
          ‚ö° Nivel Intermedio - Se introducen comandos m√°s complejos
        </div>
      </section>

      <!-- Progreso de Ejercicios -->
      <div id="exerciseProgress"></div>

      <!-- Instrucciones del Ejercicio Actual -->
      <div id="exerciseInstructions"></div>

      <!-- Grid de Dos Columnas -->
      <div
        class="grid"
        style="
          grid-template-columns: 1fr 1fr;
          gap: var(--spacing-lg);
          margin-top: var(--spacing-lg);
        "
      >
        <!-- Columna Izquierda: Gr√°fico -->
        <div class="graph" style="border-color: #d32f2f">
          <div
            class="branch-indicator"
            style="background: linear-gradient(135deg, #d32f2f, #f44336)"
          >
            <span class="branch-indicator__label">‚ö†Ô∏è L√≠nea Corrupta:</span>
            <span class="branch-indicator__value" id="currentBranchIndicator"
              >1985-dystopia</span
            >
          </div>

          <h2 class="graph__title" style="color: #ff4081">
            üíÄ Historial Corrupto
          </h2>
          <p class="graph__description">
            Visualiza el historial dist√≥pico y c√≥mo arreglarlo
          </p>

          <div class="graph__canvas" id="gitGraph"></div>

          <!-- Advertencia -->
          <div
            class="graph__info"
            style="border-color: #d32f2f; background: rgba(211, 47, 47, 0.1)"
          >
            <div class="graph__info-item">
              <span class="graph__info-label">‚ö†Ô∏è Estado:</span>
              <span class="graph__info-value" style="color: #f44336"
                >L√çNEA TEMPORAL CORRUPTA</span
              >
            </div>
            <div class="graph__info-item">
              <span class="graph__info-label">üéØ Objetivo:</span>
              <span class="graph__info-value">Restaurar 1985 original</span>
            </div>
          </div>
        </div>

        <!-- Columna Derecha: Consola -->
        <div class="console" style="border-color: #d32f2f">
          <h2 class="console__title" style="color: #ff4081">
            üñ•Ô∏è Terminal de Reparaci√≥n Temporal
          </h2>
          <p class="console__description">
            Usa comandos avanzados para restaurar la l√≠nea temporal
          </p>

          <!-- Output de la Consola -->
          <div class="console__output" id="consoleOutput">
            <div class="console__output-line console__output-line--warning">
              <span class="prompt">$</span> Doc: "¬°Marty! Este no es nuestro
              1985... algo sali√≥ terriblemente mal" üò±
            </div>
            <div class="console__output-line console__output-line--warning">
              <span class="prompt">$</span> Biff ha corrompido la l√≠nea
              temporal. Debemos usar git para arreglarlo
            </div>
          </div>

          <!-- Botones de Comandos R√°pidos -->
          <div class="console__commands">
            <button class="console__cmd-btn" data-command="log">log</button>
            <button class="console__cmd-btn" data-command="branch">
              branch
            </button>
            <button class="console__cmd-btn" data-command="checkout main">
              checkout main
            </button>
            <button class="console__cmd-btn" data-command="merge 1985-dystopia">
              merge
            </button>
            <button class="console__cmd-btn" data-command="rebase">
              rebase
            </button>
            <button class="console__cmd-btn" data-command="reset --hard HEAD~1">
              reset --hard
            </button>
            <button class="console__cmd-btn" data-command="revert HEAD">
              revert
            </button>
          </div>

          <!-- Input de Comando -->
          <div class="console__input">
            <span class="console__input-prompt" style="color: #f44336"
              >git $</span
            >
            <input
              type="text"
              class="console__input-field"
              id="commandInput"
              placeholder="Comandos de recuperaci√≥n..."
              autocomplete="off"
            />
            <button
              class="console__execute-btn"
              id="executeBtn"
              style="background: #d32f2f"
            >
              ‚ñ∂
            </button>
          </div>

          <!-- Botones Especiales -->
          <div class="console__special-buttons">
            <button
              class="console__special-btn console__special-btn--reset"
              id="resetBtn"
            >
              üîÑ Reiniciar
            </button>
            <button
              class="console__special-btn console__special-btn--demo"
              id="hintBtn"
            >
              üí° Pista
            </button>
          </div>
        </div>
      </div>

      <!-- Comparaci√≥n Visual -->
      <section class="card card--primary" style="margin-top: var(--spacing-lg)">
        <h3>‚öñÔ∏è Comparaci√≥n de L√≠neas Temporales</h3>
        <div
          style="
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-lg);
            padding: var(--spacing-md) 0;
          "
        >
          <div
            style="
              text-align: center;
              padding: var(--spacing-md);
              border: 2px solid #4caf50;
              border-radius: 8px;
            "
          >
            <div style="font-size: 48px">‚úÖ</div>
            <strong style="color: #4caf50">1985 Original</strong>
            <ul
              style="
                text-align: left;
                margin-top: var(--spacing-sm);
                color: var(--color-muted);
                font-size: 14px;
              "
            >
              <li>George es exitoso</li>
              <li>Familia feliz</li>
              <li>Biff es amable</li>
              <li>Hill Valley pr√≥spero</li>
            </ul>
          </div>
          <div
            style="
              text-align: center;
              padding: var(--spacing-md);
              border: 2px solid #f44336;
              border-radius: 8px;
            "
          >
            <div style="font-size: 48px">‚ùå</div>
            <strong style="color: #f44336">1985 Dist√≥pico</strong>
            <ul
              style="
                text-align: left;
                margin-top: var(--spacing-sm);
                color: var(--color-muted);
                font-size: 14px;
              "
            >
              <li>George est√° muerto</li>
              <li>Biff es millonario</li>
              <li>Lorraine casada con Biff</li>
              <li>Hill Valley corrupto</li>
            </ul>
          </div>
        </div>
      </section>

      <!-- Ayuda Adicional -->
      <section
        class="card card--secondary"
        style="margin-top: var(--spacing-lg)"
      >
        <h3>üéì Comandos de Recuperaci√≥n</h3>
        <div
          style="
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: var(--spacing-md);
          "
        >
          <div>
            <strong style="color: #f44336">git reset --hard [commit]</strong>
            <p class="text-muted text-sm">
              Vuelve el repositorio a un commit espec√≠fico, descartando todos
              los cambios
            </p>
            <code class="text-xs"
              >‚ö†Ô∏è PELIGRO: P√©rdida permanente de cambios</code
            >
          </div>
          <div>
            <strong style="color: #ff9100">git revert [commit]</strong>
            <p class="text-muted text-sm">
              Crea un nuevo commit que deshace los cambios de un commit anterior
            </p>
            <code class="text-xs">‚úÖ SEGURO: Preserva el historial</code>
          </div>
          <div>
            <strong style="color: #4caf50">git merge [rama]</strong>
            <p class="text-muted text-sm">
              Fusiona cambios de otra rama a la actual
            </p>
            <code class="text-xs">Combina l√≠neas temporales</code>
          </div>
        </div>
      </section>
    </main>

    <!-- Footer -->
    <footer
      class="text-center text-muted"
      style="padding: var(--spacing-xl); margin-top: var(--spacing-xl)"
    >
      <p>üöó‚ö° Git to the Future - Aprende Git usando Back to the Future</p>
      <p class="text-sm">Pantalla 3 de 4 | Dystopia (1985A)</p>
    </footer>

    <!-- JavaScript sin m√≥dulos ES6 -->
    <script src="../js/git-bttf-standalone.js"></script>
    <script>
      // Definir ejercicios para Screen 3
      SCREEN_EXERCISES.screen3 = [
        {
          id: 1,
          title: 'Inicializar la m√°quina del tiempo',
          description:
            'Crea un repositorio para documentar el problema temporal',
          expectedCommand: 'git init',
          successMessage: 'üöó Sistema temporal inicializado',
          hint: "Usa 'git init' para comenzar",
        },
        {
          id: 2,
          title: 'Crear rama dist√≥pica',
          description:
            "Crea una rama llamada 'distopia' para la l√≠nea temporal corrupta",
          expectedCommand: 'git branch distopia',
          successMessage: 'üåÜ L√≠nea temporal dist√≥pica detectada',
          hint: "Usa 'git branch distopia'",
        },
        {
          id: 3,
          title: 'Documentar la distop√≠a',
          description:
            'Cambia a la rama dist√≥pica y agrega archivos del futuro corrompido',
          expectedCommand: 'git checkout distopia',
          successMessage: '‚ö†Ô∏è Entrando en la l√≠nea temporal dist√≥pica',
          hint: "Usa 'git checkout distopia'",
        },
        {
          id: 4,
          title: 'Registrar el caos',
          description: 'Agrega y confirma los cambios de la realidad corrupta',
          expectedCommand: 'git add .',
          successMessage: 'üìã Evidencia de la distop√≠a documentada',
          hint: "Usa 'git add .' para preparar los archivos",
        },
        {
          id: 5,
          title: 'Crear commit de la distop√≠a',
          description: 'Registra el estado dist√≥pico con un commit',
          expectedCommand: 'git commit',
          successMessage: 'üíÄ Estado dist√≥pico registrado en la historia',
          hint: 'Usa \'git commit -m "mensaje"\'',
        },
        {
          id: 6,
          title: 'Regresar al presente',
          description:
            'Vuelve a la rama principal para corregir la l√≠nea temporal',
          expectedCommand: 'git checkout main',
          successMessage: 'üè† De vuelta en la l√≠nea temporal original',
          hint: "Usa 'git checkout main'",
        },
        {
          id: 7,
          title: 'Fusionar realidades',
          description: 'Fusiona la rama dist√≥pica para entender qu√© sali√≥ mal',
          expectedCommand: 'git merge distopia',
          successMessage: 'üîÑ Realidades fusionadas - conocimiento adquirido',
          hint: "Usa 'git merge distopia'",
        },
        {
          id: 8,
          title: 'Restaurar la l√≠nea temporal',
          description:
            'Usa reset para deshacer los cambios y restaurar la realidad',
          expectedCommand: 'git reset --hard HEAD~1',
          successMessage:
            '‚ú® ¬°Realidad restaurada! La distop√≠a ha sido eliminada',
          hint: "Usa 'git reset --hard HEAD~1' para deshacer el √∫ltimo commit",
        },
      ];

      document.addEventListener('DOMContentLoaded', function () {
        Logger.log('Iniciando Pantalla 3: Dystopia');

        const graph = new GitGraphController('gitGraph');
        const consoleCtrl = new ConsoleController(
          'consoleOutput',
          'commandInput',
          graph
        );
        const validator = new ExerciseValidator(consoleCtrl, graph);
        const ui = new UIController();
        const screenCtrl = new ScreenController();

        // Configurar ejercicios
        validator.setExercises(SCREEN_EXERCISES.screen3);
        consoleCtrl.setValidator(validator);

        // Renderizar UI
        screenCtrl.renderNavigation('navigationContainer');
        screenCtrl.renderBreadcrumb('breadcrumbContainer');

        const firstExercise = validator.getCurrentExercise();
        if (firstExercise) {
          ui.showExerciseInstructions(firstExercise, 'exerciseInstructions');
          ui.updateExerciseProgress(
            0,
            SCREEN_EXERCISES.screen3.length,
            'exerciseProgress'
          );
        }

        // Interceptar comandos para validaci√≥n
        const originalExecute = consoleCtrl.executeCommand.bind(consoleCtrl);
        consoleCtrl.executeCommand = function (commandString) {
          const cmd = commandString.trim().toLowerCase();

          // Comandos de ayuda no necesitan validaci√≥n
          if (
            cmd === 'hint' ||
            cmd === 'ayuda' ||
            cmd === 'help' ||
            cmd === 'clear'
          ) {
            originalExecute(commandString);
            return;
          }

          originalExecute(commandString);

          const parts = cmd.split(' ');
          const command = parts[0] === 'git' ? parts[1] : parts[0];
          const args = parts[0] === 'git' ? parts.slice(2) : parts.slice(1);

          const result = validator.validateCommand(command, args);

          if (result.valid) {
            ui.showNotification(result.message, 'success');
            const nextResult = validator.nextExercise();

            if (nextResult.completed) {
              ui.showNotification(
                'üéâ ¬°Has restaurado la l√≠nea temporal correcta!',
                'success',
                5000
              );
              ui.createConfetti();
              screenCtrl.completeScreen(3);

              setTimeout(() => {
                ui.showCompletionModal('Dystopia (1985A)', () => {
                  screenCtrl.navigateTo(4);
                });
              }, 2000);
            } else {
              ui.updateExerciseProgress(
                validator.currentExerciseIndex,
                SCREEN_EXERCISES.screen3.length,
                'exerciseProgress'
              );
              ui.showExerciseInstructions(
                nextResult.exercise,
                'exerciseInstructions'
              );
            }
          } else if (result.suggestion) {
            ui.showNotification(result.suggestion, 'info', 4000);
          }
        };

        // Event listeners
        const executeCommand = () => {
          const input = document.getElementById('commandInput');
          const command = input.value.trim();
          if (command) {
            consoleCtrl.executeCommand(command);
            input.value = '';
          }
        };

        document
          .getElementById('executeBtn')
          .addEventListener('click', executeCommand);
        document
          .getElementById('commandInput')
          .addEventListener('keypress', (e) => {
            if (e.key === 'Enter') executeCommand();
          });

        document.querySelectorAll('.console__cmd-btn').forEach((btn) => {
          btn.addEventListener('click', () => {
            const command = btn.getAttribute('data-command');
            document.getElementById('commandInput').value = command;
            document.getElementById('commandInput').focus();
          });
        });

        const resetBtn = document.getElementById('resetBtn');
        if (resetBtn) {
          resetBtn.addEventListener('click', () => {
            if (
              confirm(
                '¬øEst√°s seguro de reiniciar? Perder√°s todo el progreso de esta pantalla.'
              )
            ) {
              consoleCtrl.resetAll();
              validator.reset();
              ui.showExerciseInstructions(
                SCREEN_EXERCISES.screen3[0],
                'exerciseInstructions'
              );
              ui.updateExerciseProgress(
                0,
                SCREEN_EXERCISES.screen3.length,
                'exerciseProgress'
              );
              ui.showNotification('üîÑ Pantalla reiniciada', 'info');
            }
          });
        }

        const hintBtn = document.getElementById('hintBtn');
        if (hintBtn) {
          hintBtn.addEventListener('click', () => {
            const exercise = validator.getCurrentExercise();
            if (exercise) {
              ui.showNotification(`üí° ${exercise.hint}`, 'warning', 6000);
            }
          });
        }

        // Actualizar indicador de rama
        const originalCheckout = graph.checkout.bind(graph);
        graph.checkout = function (branchName) {
          const result = originalCheckout(branchName);
          if (result) ui.updateBranchIndicator(branchName);
          return result;
        };

        Logger.log('Pantalla 3 inicializada correctamente');
      });

      // Actualizar indicador
      const originalCheckout = graph.checkout.bind(graph);
      graph.checkout = function (branchName) {
        const result = originalCheckout(branchName);
        if (result) {
          ui.updateBranchIndicator(branchName);
        }
        return result;
      };

      Logger.log('Pantalla 3 lista - Modo Dist√≥pico activado');
    </script>
  </body>
</html>
