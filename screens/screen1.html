<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pantalla 1: Origin (1985‚Üí1955) | Git to the Future</title>

    <!-- CSS Modular -->
    <link rel="stylesheet" href="../css/variables.css" />
    <link rel="stylesheet" href="../css/components/base.css" />
    <link rel="stylesheet" href="../css/components/branch-indicator.css" />
    <link rel="stylesheet" href="../css/components/console.css" />
    <link rel="stylesheet" href="../css/components/graph.css" />
    <link rel="stylesheet" href="../css/components/navigation.css" />
    <link rel="stylesheet" href="../css/screens.css" />

    <!-- GitGraph CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@gitgraph/js"></script>
  </head>
  <body class="screen-body screen-1">
    <!-- Header con Logo y Back Button -->
    <header class="screen-header">
      <div class="screen-header__left">
        <a href="../index-menu.html" title="Volver al men√∫ principal">
          <img
            src="../assets/fonts/img/Back.png"
            alt="Volver"
            class="screen-header__back"
          />
        </a>
      </div>
      <a href="../index.html">
        <img
          src="../assets/fonts/img/GItToTheFuture.png"
          alt="Git to the Future"
          class="screen-header__logo"
        />
      </a>

      <!-- Barra de Progreso Radioactiva (Superior Derecha) -->
      <div class="plutonium-progress">
        <span class="plutonium-progress__label">PROGRESO</span>
        <div class="plutonium-progress__tube">
          <div
            class="plutonium-progress__fill"
            id="progressBarFill"
            style="width: 0%"
          >
            <div class="plutonium-progress__glow"></div>
          </div>
          <span class="plutonium-progress__counter" id="progressCounter"
            >0/6</span
          >
        </div>
      </div>
    </header>

    <!-- Layout Principal de 3 Columnas -->
    <main class="screen-main">
      <!-- COLUMNA IZQUIERDA: Consola Git Interactiva (PROTAGONISTA - 55-60%) -->
      <div class="screen-left">
        <!-- Consola -->
        <div class="console-card">
          <div class="console-card__header">
            <h2 class="console-card__title">Git Terminal</h2>
          </div>

          <!-- Output de la Consola -->
          <div class="console__output" id="consoleOutput">
          </div>

          <!-- Botones de Comandos R√°pidos -->
          <div class="console__commands">
            <button class="console__cmd-btn" data-command="init">init</button>
            <button class="console__cmd-btn" data-command="status">
              status
            </button>
            <button class="console__cmd-btn" data-command="add .">add .</button>
            <button class="console__cmd-btn" data-command="commit -m 'mensaje'">
              commit
            </button>
            <button class="console__cmd-btn" data-command="branch">
              branch
            </button>
            <button class="console__cmd-btn" data-command="checkout">
              checkout
            </button>
            <button class="console__cmd-btn" data-command="merge">merge</button>
          </div>

          <!-- Input de Comando -->
          <div class="console__input">
            <span class="console__input-prompt">git $</span>
            <input
              type="text"
              class="console__input-field"
              id="commandInput"
              placeholder="Escribe tu comando aqu√≠..."
              autocomplete="off"
            />
            <button class="console__execute-btn" id="executeBtn">‚ñ∂</button>
          </div>

          <!-- Botones Especiales -->
          <div class="console__special-buttons">
            <button
              class="console__special-btn console__special-btn--reset"
              id="resetBtn"
            >
              Reiniciar
            </button>
            <button
              class="console__special-btn console__special-btn--demo"
              id="hintBtn"
            >
              Pista
            </button>
          </div>
        </div>
      </div>

      <!-- COLUMNA CENTRAL: Visualizador de √Årbol Git (SECUNDARIA - 20-25%) -->
      <div class="screen-center">
        <!-- Gr√°fico Git -->
        <div class="graph-card">
          <div class="graph-card__header">
            <h2 class="graph-card__title">Git Timeline</h2>
          </div>

          <div class="graph__canvas" id="gitGraph">
            <div class="graph__empty">
              <div class="graph__empty-text">
                DeLorean listo para el viaje temporal
              </div>
              <div class="graph__empty-hint">
                Ejecuta "git init" para comenzar
              </div>
            </div>
          </div>

          <!-- Branch Indicator movido abajo -->
          <div class="branch-indicator">
            <span class="branch-indicator__label">Branch:</span>
            <span class="branch-indicator__value" id="currentBranchIndicator"
              >Sin repositorio</span
            >
          </div>
        </div>
      </div>

      <!-- COLUMNA DERECHA: Cards de Informaci√≥n (CONTEXTO - 15-20%) -->
      <div class="screen-right">
        <!-- Tarjeta de Misi√≥n -->
        <div class="mission-card mission-card--objective">
          <h2 class="mission-card__title">üéØ Mission Objective</h2>
          <p class="mission-card__text" id="exerciseInstructions">
            <strong>Challenge 1:</strong> Inicializa tu primer repositorio Git
          </p>
        </div>

        <!-- Historia del Nivel -->
        <div class="mission-card">
          <h2 class="mission-card__title">Level Context</h2>
          <p class="mission-card__description" style="margin-bottom: 8px">
            <strong>Pel√≠cula:</strong> Back to the Future (1985)<br />
            <strong>A√±o:</strong> 1955<br />
            <strong>Director:</strong> Robert Zemeckis
          </p>
          <p class="mission-card__description" style="margin-bottom: 8px">
            Marty McFly, un adolescente de Hill Valley en 1985, es amigo de un
            cient√≠fico exc√©ntrico llamado Doc Brown. Una noche, Doc le muestra
            su invento m√°s ambicioso: un DeLorean convertido en m√°quina del
            tiempo.
          </p>
          <p class="mission-card__description" style="margin-bottom: 8px">
            Durante la demostraci√≥n, son atacados por terroristas libios. En el
            escape, Marty activa accidentalmente el condensador de flujo y viaja
            30 a√±os al pasado, a 1955. All√≠ conoce a sus padres adolescentes y,
            sin querer, interfiere con su primer encuentro rom√°ntico.
          </p>
          <p class="mission-card__description">
            Ahora, con la ayuda del joven Doc Brown, Marty debe encontrar una
            forma de generar suficiente energ√≠a (1.21 gigawatts) para activar el
            condensador de flujo y regresar a su √©poca, mientras asegura que sus
            padres se enamoren para no desaparecer de la existencia.
          </p>
          <div
            style="
              margin-top: 10px;
              padding-top: 10px;
              border-top: 1px solid rgba(255, 255, 255, 0.1);
            "
          >
            <img
              src="../assets/fonts/img/thunder.png"
              alt="1955"
              style="
                width: 100%;
                max-width: 180px;
                height: auto;
                margin: 0 auto;
                display: block;
                border-radius: 6px;
                filter: drop-shadow(0 4px 12px rgba(0, 0, 0, 0.3));
              "
            />
          </div>
        </div>
      </div>
    </main>

    <!-- JavaScript sin m√≥dulos ES6 -->
    <script src="../js/git-bttf-standalone.js"></script>
    <script>
      // Inicializar cuando se cargue la p√°gina
      document.addEventListener('DOMContentLoaded', function () {
        Logger.log('Iniciando Pantalla 1: Origin');

        // 1Ô∏è‚É£ Inicializar controladores
        const graph = new GitGraphController('gitGraph');
        const consoleCtrl = new ConsoleController(
          'consoleOutput',
          'commandInput',
          graph
        );
        const validator = new ExerciseValidator(consoleCtrl, graph);
        const ui = new UIController();
        const screenCtrl = new ScreenController();

        // 2Ô∏è‚É£ Configurar ejercicios y conectar validador
        validator.setExercises(SCREEN_EXERCISES.screen1);
        consoleCtrl.setValidator(validator);

        // 3Ô∏è‚É£ Funci√≥n para actualizar la UI del progreso
        function updateProgress() {
          const current = validator.currentExerciseIndex;
          const total = SCREEN_EXERCISES.screen1.length;
          const percentage = Math.round((current / total) * 100);

          const progressFill = document.getElementById('progressBarFill');
          const progressCounter = document.getElementById('progressCounter');

          if (progressFill) {
            progressFill.style.width = percentage + '%';
          }

          if (progressCounter) {
            // Mostrar ejercicios completados (current ya incluye el ejercicio actual)
            progressCounter.textContent = `${current}/${total}`;
          }

          // Debug para verificar
          console.log(
            `Progreso actualizado: ${current}/${total} (${percentage}%)`
          );
        }

        // 4Ô∏è‚É£ Funci√≥n para actualizar instrucciones
        function updateInstructions(exercise) {
          const container = document.getElementById('exerciseInstructions');
          if (container && exercise) {
            container.innerHTML = `<strong>Ejercicio ${
              validator.currentExerciseIndex + 1
            }:</strong> ${exercise.description}`;
          }
        }

        // 5Ô∏è‚É£ Mostrar primer ejercicio
        updateInstructions(validator.getCurrentExercise());
        updateProgress();

        // 6Ô∏è‚É£ Interceptar comandos para validaci√≥n autom√°tica
        const originalExecute = consoleCtrl.executeCommand.bind(consoleCtrl);
        consoleCtrl.executeCommand = function (commandString) {
          const cmd = commandString.trim().toLowerCase();

          // Comandos de ayuda no necesitan validaci√≥n
          if (
            cmd === 'hint' ||
            cmd === 'ayuda' ||
            cmd === 'help' ||
            cmd === 'clear'
          ) {
            originalExecute(commandString);
            return;
          }

          // Ejecutar comando
          originalExecute(commandString);

          // Validar ejercicio actual
          const parts = cmd.split(' ');
          const command = parts[0] === 'git' ? parts[1] : parts[0];
          const args = parts[0] === 'git' ? parts.slice(2) : parts.slice(1);

          const result = validator.validateCommand(command, args);

          if (result.valid) {
            // ‚úÖ Comando correcto
            ui.showNotification(result.message, 'success');

            const nextResult = validator.nextExercise();

            if (nextResult.completed) {
              // üéâ ¬°Pantalla completada!
              ui.showNotification(
                'üéâ ¬°Has completado la Pantalla 1!',
                'success',
                5000
              );
              ui.createConfetti();
              screenCtrl.completeScreen(1);

              setTimeout(() => {
                ui.showCompletionModal('Origin (1985‚Üí1955)', () => {
                  screenCtrl.navigateTo(2);
                });
              }, 2000);
            } else {
              // üìù Mostrar siguiente ejercicio
              updateProgress();
              updateInstructions(nextResult.exercise);
            }
          } else if (result.suggestion) {
            // ‚ö†Ô∏è Mostrar sugerencia
            ui.showNotification(result.suggestion, 'info', 4000);
          }
        };

        // 7Ô∏è‚É£ Event Listeners
        // Ejecutar comando con bot√≥n o Enter
        const executeCommand = () => {
          const input = document.getElementById('commandInput');
          const command = input.value.trim();
          if (command) {
            consoleCtrl.executeCommand(command);
            input.value = '';
          }
        };

        document
          .getElementById('executeBtn')
          .addEventListener('click', executeCommand);
        document
          .getElementById('commandInput')
          .addEventListener('keypress', (e) => {
            if (e.key === 'Enter') executeCommand();
          });

        // Botones de comando r√°pido
        document.querySelectorAll('.console__cmd-btn').forEach((btn) => {
          btn.addEventListener('click', () => {
            const command = btn.getAttribute('data-command');
            document.getElementById('commandInput').value = command;
            document.getElementById('commandInput').focus();
          });
        });

        // Bot√≥n de reiniciar
        document.getElementById('resetBtn').addEventListener('click', () => {
          if (
            confirm(
              '¬øEst√°s seguro de reiniciar? Perder√°s todo el progreso de esta pantalla.'
            )
          ) {
            consoleCtrl.resetAll();
            validator.reset();
            updateInstructions(SCREEN_EXERCISES.screen1[0]);
            updateProgress();
            ui.showNotification('üîÑ Pantalla reiniciada', 'info');
          }
        });

        // Bot√≥n de pista progresiva (si existe)
        const hintBtn = document.getElementById('hintBtn');
        if (hintBtn) {
          hintBtn.addEventListener('click', () => {
            const exercise = validator.getCurrentExercise();
            if (exercise) {
              ui.showNotification(`üí° ${exercise.hint}`, 'warning', 6000);
            }
          });
        }

        // Actualizar indicador de rama
        const originalCheckout = graph.checkout.bind(graph);
        graph.checkout = function (branchName) {
          const result = originalCheckout(branchName);
          if (result) ui.updateBranchIndicator(branchName);
          return result;
        };

        Logger.log('Pantalla 1 inicializada correctamente');
      });
    </script>
  </body>
</html>
