<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pantalla 4: Rescate en el Lejano Oeste | Git to the Future</title>

    <!-- CSS Modular -->
    <link rel="stylesheet" href="../css/variables.css" />
    <link rel="stylesheet" href="../css/components/base.css" />
    <link rel="stylesheet" href="../css/components/branch-indicator.css" />
    <link rel="stylesheet" href="../css/components/console.css" />
    <link rel="stylesheet" href="../css/components/graph.css" />
    <link rel="stylesheet" href="../css/components/navigation.css" />
    <link rel="stylesheet" href="../css/screens.css" />

    <!-- GitGraph CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@gitgraph/js"></script>
  </head>
  <body class="screen-body screen-4">
    <!-- Header con Logo y Back Button -->
    <header class="screen-header">
      <div class="screen-header__left">
        <a
          href="../index-menu.html"
          title="Volver al men√∫ principal"
          id="backBtn"
        >
          <img
            src="../assets/fonts/img/Back.png"
            alt="Volver"
            class="screen-header__back"
          />
        </a>
      </div>
      <a href="../index.html">
        <img
          src="../assets/fonts/img/GItToTheFuture.png"
          alt="Git to the Future"
          class="screen-header__logo"
        />
      </a>

      <!-- Barra de Progreso Radioactiva (Superior Derecha) -->
      <div class="plutonium-progress">
        <span class="plutonium-progress__label">PROGRESO</span>
        <div class="plutonium-progress__tube">
          <div
            class="plutonium-progress__fill"
            id="progressBarFill"
            style="width: 0%"
          >
            <div class="plutonium-progress__glow"></div>
          </div>
          <span class="plutonium-progress__counter" id="progressCounter"
            >0/9</span
          >
        </div>
      </div>
    </header>

    <!-- Layout Principal de 3 Columnas -->
    <main class="screen-main">
      <!-- COLUMNA IZQUIERDA: Consola Git Interactiva (PROTAGONISTA - 55-60%) -->
      <div class="screen-left">
        <!-- Consola -->
        <div class="console-card">
          <div class="console-card__header">
            <h2 class="console-card__title">Git Terminal</h2>
          </div>

          <!-- Output de la Consola -->
          <div class="console__output" id="consoleOutput"></div>

          <!-- Botones de Comandos R√°pidos -->
          <div class="console__commands">
            <button class="console__cmd-btn" data-command="stash">stash</button>
            <button
              class="console__cmd-btn"
              data-command="branch aventura/viejo-oeste"
            >
              branch
            </button>
            <button
              class="console__cmd-btn"
              data-command="checkout aventura/viejo-oeste"
            >
              checkout
            </button>
            <button class="console__cmd-btn" data-command="add .">add .</button>
            <button class="console__cmd-btn" data-command="commit -m 'mensaje'">
              commit
            </button>
            <button class="console__cmd-btn" data-command="checkout main">
              main
            </button>
            <button class="console__cmd-btn" data-command="branch -a">
              branch -a
            </button>
          </div>

          <!-- Input de Comando -->
          <div class="console__input">
            <span class="console__input-prompt">git $</span>
            <input
              type="text"
              class="console__input-field"
              id="commandInput"
              placeholder="Escribe tu comando aqu√≠..."
              autocomplete="off"
            />
            <button class="console__execute-btn" id="executeBtn">‚ñ∂</button>
          </div>

          <!-- Botones Especiales -->
          <div class="console__special-buttons">
            <button
              class="console__special-btn console__special-btn--reset"
              id="resetBtn"
            >
              Reiniciar
            </button>
            <button
              class="console__special-btn console__special-btn--demo"
              id="hintBtn"
            >
              Pista
            </button>
          </div>
        </div>
      </div>

      <!-- COLUMNA CENTRAL: Visualizador de √Årbol Git (SECUNDARIA - 20-25%) -->
      <div class="screen-center">
        <!-- Gr√°fico Git -->
        <div class="graph-card">
          <div class="graph-card__header">
            <h2 class="graph-card__title">Git Timeline</h2>
          </div>

          <div class="graph__canvas" id="gitGraph">
            <div class="graph__empty">
              <div class="graph__empty-line"></div>
              <div class="graph__empty-line"></div>
              <div class="graph__empty-text">
                Visualizador de L√≠neas Temporales
              </div>
              <div class="graph__empty-line"></div>
              <div class="graph__empty-hint">
                Aqu√≠ ver√°s todas las ramas, commits y fusiones de tu repositorio
              </div>
              <div class="graph__empty-hint">
                Git en forma de √°rbol visual. Ejecuta "git init" para comenzar.
              </div>
              <div class="graph__empty-line"></div>
            </div>
          </div>

          <!-- Branch Indicator -->
          <div class="branch-indicator">
            <span class="branch-indicator__label"></span>
            <span class="branch-indicator__value" id="currentBranchIndicator"
              >Sin repositorio</span
            >
          </div>
        </div>
      </div>

      <!-- COLUMNA DERECHA: Cards de Informaci√≥n (CONTEXTO - 15-20%) -->
      <div class="screen-right">
        <!-- Tarjeta de Misi√≥n -->
        <div class="mission-card mission-card--objective">
          <h2 class="mission-card__title">Mission Objective</h2>
          <p class="mission-card__text" id="exerciseInstructions">
            Prepara rescate en el Oeste
          </p>
        </div>

        <!-- Historia del Nivel -->
        <div class="mission-card">
          <h2 class="mission-card__title">Level Context</h2>
          <p
            class="mission-card__description"
            style="margin-bottom: 12px; font-size: 13px; line-height: 1.6"
          >
            <strong style="color: #bcaaa4">ü§† Rescate en el Lejano Oeste</strong
            ><br />
            <strong>üìÖ A√±o:</strong> 1885 (Lejano Oeste)<br />
            <strong>‚ù§Ô∏è Subplot:</strong> Doc y Clara
          </p>
          <p
            class="mission-card__description"
            style="font-size: 13px; line-height: 1.6"
          >
            Un rayo env√≠a a Doc a 1885. Marty est√° en 1955 y debe guardar su
            trabajo con git stash para concentrarse en el rescate. Crear√° una
            branch para la aventura del Oeste donde Doc salva a Clara y se
            enamora. La rama de Doc seguir√° existiendo independientemente (git
            branch -a) mientras Marty regresa solo a 1985. Un fork natural de la
            vida de Doc.
          </p>
          <div
            style="
              margin-top: 12px;
              padding-top: 12px;
              border-top: 1px solid rgba(255, 255, 255, 0.1);
            "
          >
            <img
              src="../assets/fonts/img/thunder.png"
              alt="1885"
              style="
                width: 100%;
                max-width: 180px;
                height: auto;
                margin: 0 auto;
                display: block;
                border-radius: 6px;
                filter: drop-shadow(0 4px 12px rgba(0, 0, 0, 0.3));
              "
            />
          </div>
        </div>

        <!-- Tarjeta de Pista -->
        <div
          class="mission-card mission-card--hint"
          id="hintCard"
          style="display: none"
        >
          <h2 class="mission-card__title">PISTA</h2>
          <p
            class="mission-card__text"
            id="hintText"
            style="
              font-size: 13px;
              line-height: 1.6;
              color: rgba(255, 255, 255, 0.9);
            "
          >
            <!-- La pista se mostrar√° aqu√≠ -->
          </p>
        </div>
      </div>
    </main>

    <!-- JavaScript sin m√≥dulos ES6 -->
    <script src="../js/git-bttf-standalone.js"></script>
    <script>
      // Inicializar cuando se cargue la p√°gina
      document.addEventListener('DOMContentLoaded', function () {
        Logger.log('Iniciando Pantalla 4: Wild West');

        // 1Ô∏è‚É£ Inicializar controladores
        const graph = new GitGraphController('gitGraph');
        const consoleCtrl = new ConsoleController(
          'consoleOutput',
          'commandInput',
          graph
        );
        const validator = new ExerciseValidator(consoleCtrl, graph);
        const ui = new UIController();
        const screenCtrl = new ScreenController();

        // 2Ô∏è‚É£ Configurar ejercicios y conectar validador
        validator.setExercises(SCREEN_EXERCISES.screen4);
        consoleCtrl.setValidator(validator);

        // üé¨ Hardcoded: Repositorio 1955 con delorean.txt modificado
        consoleCtrl.state.initialized = true;
        consoleCtrl.state.branches = ['main', '1955', '1885'];
        consoleCtrl.state.currentBranch = '1955';
        consoleCtrl.state.files = ['delorean.txt'];
        consoleCtrl.state.stagedFiles = [];
        consoleCtrl.state.stash = [];

        // Inicializar grafo
        graph.init();

        // Commits iniciales
        graph.commit('1985: Estado inicial');
        consoleCtrl.state.commits.push({
          hash: 'aaa1985',
          message: '1985: Estado inicial',
          branch: 'main',
          timestamp: Date.now(),
        });

        // Crear branch 1955
        graph.branch('1955');
        graph.checkout('1955');
        consoleCtrl.state.currentBranch = '1955';

        graph.commit('Llegada a 1955');
        consoleCtrl.state.commits.push({
          hash: 'bbb1955',
          message: 'Llegada a 1955',
          branch: '1955',
          timestamp: Date.now(),
        });

        // Crear branch 1885 desde 1955
        graph.branch('1885');

        // Simular archivo modificado en working directory
        consoleCtrl.state.modifiedFiles = ['delorean.txt'];

        // Actualizar indicador de rama inicial (1955)
        consoleCtrl.updateBranchIndicator();

        consoleCtrl.addOutput('üìç Est√°s en 1955. Branch actual: 1955');
        consoleCtrl.addOutput('‚ö†Ô∏è Archivo modificado: delorean.txt');
        consoleCtrl.addOutput('üí° El DeLorean ha sido alcanzado por un rayo');
        consoleCtrl.addOutput('üîß Usa "git status" para ver los cambios');

        // 3Ô∏è‚É£ Funci√≥n para actualizar la UI del progreso
        function updateProgress() {
          const current = validator.currentExerciseIndex;
          const total = SCREEN_EXERCISES.screen4.length;
          // Calcular porcentaje: cuando current === total, debe ser 100%
          const percentage = Math.round((current / total) * 100);

          const progressFill = document.getElementById('progressBarFill');
          const progressCounter = document.getElementById('progressCounter');

          if (progressFill) {
            progressFill.style.width = percentage + '%';
          }

          if (progressCounter) {
            // Mostrar ejercicios completados
            progressCounter.textContent = `${current}/${total}`;
          }

          // Debug para verificar
          console.log(
            `Progreso actualizado: ${current}/${total} (${percentage}%)`
          );
        }

        // 4Ô∏è‚É£ Funci√≥n para actualizar instrucciones
        function updateInstructions(exercise) {
          const container = document.getElementById('exerciseInstructions');
          if (container && exercise) {
            container.textContent = exercise.description;
          }
        }

        // 5Ô∏è‚É£ Mostrar primer ejercicio
        updateInstructions(validator.getCurrentExercise());
        updateProgress();

        // 6Ô∏è‚É£ Interceptar comandos para validaci√≥n autom√°tica
        const originalExecute = consoleCtrl.executeCommand.bind(consoleCtrl);
        consoleCtrl.executeCommand = function (commandString) {
          const cmd = commandString.trim().toLowerCase();

          // Comandos de ayuda no necesitan validaci√≥n
          if (
            cmd === 'hint' ||
            cmd === 'ayuda' ||
            cmd === 'help' ||
            cmd === 'clear'
          ) {
            originalExecute(commandString);
            return;
          }

          // Ejecutar comando
          originalExecute(commandString);

          // ‚ùó VERIFICAR QUE EL COMANDO SE HAYA EJECUTADO EXITOSAMENTE
          if (!consoleCtrl.lastCommandSuccess) {
            // Si el comando fall√≥, no validar el ejercicio
            console.log('‚ùå Comando fall√≥, no se valida el ejercicio');
            return;
          }

          // Validar ejercicio actual
          const parts = cmd.split(' ');
          const command = parts[0] === 'git' ? parts[1] : parts[0];
          const args = parts[0] === 'git' ? parts.slice(2) : parts.slice(1);

          const result = validator.validateCommand(command, args);

          if (result.valid) {
            // ‚úÖ Comando correcto - Sin notificaci√≥n popup
            const nextResult = validator.nextExercise();

            if (nextResult.completed) {
              // Actualizar progreso al 100% antes de mostrar completaci√≥n
              updateProgress();

              // üéâ ¬°Pantalla completada!
              ui.showNotification(
                'üéâ ¬°Has completado la Pantalla 4!',
                'success',
                5000
              );
              ui.createConfetti();
              screenCtrl.completeScreen(4);

              setTimeout(() => {
                ui.showCompletionModal('Wild West (1885)', () => {
                  screenCtrl.navigateTo('index-menu.html');
                });
              }, 2000);
            } else {
              // üìù Mostrar siguiente ejercicio
              updateProgress();
              updateInstructions(nextResult.exercise);
            }
          } else if (result.shouldShowError) {
            // ‚ùå Mostrar error solo si el comando es del tipo esperado pero con argumentos incorrectos
            const errorMsg =
              result.message ||
              result.suggestion ||
              '‚ùå Comando incorrecto. Usa "hint" para obtener ayuda.';
            ui.showNotification(errorMsg, 'error', 4000);
          }
          // Si no es el tipo de comando esperado, no mostrar error (permitir explorar)
        };

        // 7Ô∏è‚É£ Event Listeners
        // Ejecutar comando con bot√≥n o Enter
        const executeCommand = () => {
          const input = document.getElementById('commandInput');
          const command = input.value.trim();
          if (command) {
            consoleCtrl.executeCommand(command);
            input.value = '';
          }
        };

        document
          .getElementById('executeBtn')
          .addEventListener('click', executeCommand);
        document
          .getElementById('commandInput')
          .addEventListener('keypress', (e) => {
            if (e.key === 'Enter') executeCommand();
          });

        // Botones de comando r√°pido
        document.querySelectorAll('.console__cmd-btn').forEach((btn) => {
          btn.addEventListener('click', () => {
            const command = btn.getAttribute('data-command');
            document.getElementById('commandInput').value = command;
            document.getElementById('commandInput').focus();
          });
        });

        // Bot√≥n de reiniciar
        document.getElementById('resetBtn').addEventListener('click', () => {
          if (
            confirm(
              '¬øEst√°s seguro de reiniciar? Perder√°s todo el progreso de esta pantalla.'
            )
          ) {
            consoleCtrl.resetAll();
            validator.reset();
            updateInstructions(SCREEN_EXERCISES.screen4[0]);
            updateProgress();
            ui.showNotification('üîÑ Pantalla reiniciada', 'info');
          }
        });

        // Bot√≥n de pista progresiva (si existe)
        const hintBtn = document.getElementById('hintBtn');
        if (hintBtn) {
          hintBtn.addEventListener('click', () => {
            const exercise = validator.getCurrentExercise();
            const hintCard = document.getElementById('hintCard');
            const hintText = document.getElementById('hintText');

            if (exercise && hintCard && hintText) {
              hintText.textContent = exercise.hint;

              // Remover clase hide si existe
              hintCard.classList.remove('hide');

              // Mostrar con animaci√≥n
              hintCard.style.display = 'block';

              // Forzar reflow para que la animaci√≥n funcione
              void hintCard.offsetWidth;

              // Agregar clase show para activar animaci√≥n
              hintCard.classList.add('show');

              // Auto-ocultar despu√©s de 8 segundos con animaci√≥n
              setTimeout(() => {
                hintCard.classList.remove('show');
                hintCard.classList.add('hide');

                // Esperar a que termine la animaci√≥n antes de ocultar
                setTimeout(() => {
                  hintCard.style.display = 'none';
                  hintCard.classList.remove('hide');
                }, 400);
              }, 8000);
            }
          });
        }

        // Actualizar indicador de rama cuando se inicializa
        const originalInit = graph.init.bind(graph);
        graph.init = function () {
          const result = originalInit();
          if (result) {
            consoleCtrl.state.currentBranch = 'main';
            consoleCtrl.updateBranchIndicator();
          }
          return result;
        };

        // Interceptor de checkout: solo maneja el grafo, gitCheckout() maneja el estado
        const originalCheckout = graph.checkout.bind(graph);
        graph.checkout = function (branchName) {
          console.log('üîî Interceptor checkout llamado:', branchName);
          console.log(
            'üìã Ramas disponibles en grafo:',
            Object.keys(graph.branches)
          );

          // Si es un a√±o (commit simulado), no intentar checkout en el grafo
          const isSimulatedCommit = /^\d{4}$/.test(branchName);
          if (isSimulatedCommit) {
            console.log('üìÖ Detectado commit simulado (a√±o):', branchName);
            // El estado ya fue actualizado por gitCheckout(), solo retornar true
            return true;
          }

          const result = originalCheckout(branchName);
          console.log('üìä Resultado de checkout en grafo:', result);
          if (!result) {
            console.warn('‚ö†Ô∏è Checkout en grafo fall√≥ para:', branchName);
          }
          // No actualizar el estado aqu√≠, gitCheckout() ya lo hizo
          return result;
        };

        // Confirmar antes de salir si hay progreso
        const backBtn = document.getElementById('backBtn');
        if (backBtn) {
          backBtn.addEventListener('click', (e) => {
            const currentExercise = validator.getCurrentExercise();
            // Si ya complet√≥ al menos un ejercicio, mostrar advertencia
            if (currentExercise && currentExercise.id > 1) {
              e.preventDefault();
              const confirmed = confirm(
                '‚ö†Ô∏è Si regresas al men√∫, perder√°s todo tu progreso en este nivel.\n\n¬øEst√°s seguro de que quieres salir?'
              );
              if (confirmed) {
                window.location.href = backBtn.getAttribute('href');
              }
            }
            // Si est√° en el primer ejercicio, dejar salir sin confirmar
          });
        }

        Logger.log('Pantalla 4 inicializada correctamente');
      });
    </script>
  </body>
</html>
